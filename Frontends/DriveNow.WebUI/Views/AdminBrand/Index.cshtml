@model List<DriveNow.Dtos.BrandDtos.ResultBrandDto>
@{
    ViewData["Title"] = "Brand Management";
    Layout = "~/Views/AdminLayout/Index.cshtml";
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
    :root {
        --body-bg: #F5F7FB;
        --text: #111827;
        --muted: #6B7280;
        --border: #E5E7EB;
        --card: #FFFFFF;
        --primary: #6366F1; /* indigo-500 */
        --primary-hover: #4F46E5;
        --success: #10B981;
        --warning: #F59E0B;
        --danger: #EF4444;
        --shadow-sm: 0 2px 8px rgba(0,0,0,.06);
        --shadow-md: 0 6px 18px rgba(0,0,0,.08);
        --ring: 0 0 0 4px rgba(99,102,241,.15);
    }

    body {
        background: var(--body-bg);
        color: var(--text);
    }

    .page-wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 4.5rem 1.25rem;
    }

    /* Header / Toolbar */
    .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.25rem;
    }

    .h-title {
        font-weight: 800;
        margin: 0
    }

    .subtle {
        color: var(--muted);
        font-size: .95rem
    }

    .toolbar {
        background: var(--card);
        border: 1px solid var(--border);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        display: flex;
        gap: .75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .search {
        position: relative;
        flex: 1;
        min-width: 260px;
    }

        .search input {
            width: 100%;
            background: #F9FAFB;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: .65rem .9rem .65rem 2.25rem;
            outline: none;
            transition: border .15s ease, box-shadow .15s ease, background .15s ease;
        }

            .search input:focus {
                background: #fff;
                border-color: var(--primary);
                box-shadow: var(--ring);
            }

        .search .icon {
            position: absolute;
            left: .75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
        }

    /* Buttons */
    .btn-primary-soft {
        background: linear-gradient(180deg, var(--primary), var(--primary-hover));
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: .65rem 1rem;
        font-weight: 700;
        box-shadow: 0 6px 16px rgba(79,70,229,.25);
        transition: transform .12s ease, box-shadow .2s ease;
    }

        .btn-primary-soft:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(79,70,229,.28);
        }

    .btn-outline {
        background: #fff;
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 10px;
        padding: .6rem .9rem;
        font-weight: 700;
    }

    .btn-mini {
        border: none;
        border-radius: 10px;
        padding: .48rem .7rem;
        font-weight: 700;
        color: #fff;
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        box-shadow: var(--shadow-sm);
        transition: transform .12s ease, filter .2s ease;
    }

        .btn-mini i {
            opacity: .9
        }

    .btn-edit {
        background: linear-gradient(180deg, #F59E0B, #F59E0B);
    }

        .btn-edit:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
        }

    .btn-del {
        background: linear-gradient(180deg, #EF4444, #EF4444);
    }

        .btn-del:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
        }

    /* Cards */
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
        gap: 14px;
        margin-top: .75rem;
    }

    .card-brand {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow-sm);
        padding: 1rem;
        transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
    }

        .card-brand:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: #D9DADE;
        }

    .logo-wrap {
        width: 84px;
        height: 84px;
        border-radius: 10px;
        background: #F3F4F6;
        border: 1px solid var(--border);
        display: grid;
        place-items: center;
        margin: 4px auto 12px;
        overflow: hidden;
    }

        .logo-wrap img {
            width: 70px;
            height: 70px;
            object-fit: contain
        }

        .logo-wrap i {
            font-size: 28px;
            color: #9CA3AF
        }

    .brand-name {
        font-weight: 800;
        text-align: center;
        margin: .2rem 0 .7rem
    }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: .25rem .55rem;
        background: #F3F4F6;
        border: 1px solid var(--border);
        border-radius: 999px;
        color: var(--muted);
        font-size: .8rem;
    }

    .actions {
        display: flex;
        gap: .45rem;
        justify-content: center;
        margin-top: .6rem
    }

    .empty {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        padding: 2rem;
        text-align: center;
        color: var(--muted);
        margin-top: .75rem;
    }

    /* Modals: fully opaque & crisp */
    .modal-content {
        background: #fff;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow-md);
    }

    .modal-header {
        border-bottom: 1px solid var(--border)
    }

    .modal-footer {
        border-top: 1px solid var(--border)
    }

    .form-control, .form-control:focus {
        background: #fff;
        border: 1px solid var(--border);
        color: var(--text);
        box-shadow: none
    }

    .form-text {
        color: var(--muted)
    }

    /* Tiny toast */
    .toast-lite {
        position: fixed;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 3000;
        display: none;
        padding: .6rem 1rem;
        font-weight: 700;
        border-radius: 10px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text);
    }

    .toast-ok {
        border-color: #D1FAE5;
        background: #ECFDF5;
        color: #065F46
    }

    .toast-err {
        border-color: #FECACA;
        background: #FEF2F2;
        color: #7F1D1D
    }
</style>

<div class="page-wrap">
    <div class="header">
        <div>
            <h3 class="h-title">Brand Management</h3>
            <p class="subtle mb-0">Manage automobile brands from a single page.</p>
        </div>
        <button class="btn-primary-soft" data-bs-toggle="modal" data-bs-target="#createBrandModal">
            <i class="fas fa-plus me-1"></i> Add Brand
        </button>
    </div>

    <div class="toolbar">
        <div class="search">
            <i class="fas fa-search icon"></i>
            <input id="searchInput" placeholder="Search brand…" />
        </div>
        <span class="subtle ms-auto">
            <i class="fas fa-list me-1"></i>
            <span id="brandCount">@(Model?.Count ?? 0)</span> brands
        </span>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="grid" id="brandGrid">
            @foreach (var b in Model)
            {
                <div class="card-brand" data-name="@b.BrandName.ToLower()">
                    <div class="logo-wrap">
                        @if (!string.IsNullOrWhiteSpace(b.LogoUrl))
                        {
                            <img src="@b.LogoUrl" alt="@b.BrandName logo"
                                 onerror="this.remove();this.parentElement.querySelector('i')?.classList.remove('d-none')" />
                            <i class="fas fa-car d-none"></i>
                        }
                        else
                        {
                            <i class="fas fa-car"></i>
                        }
                    </div>

                    <div class="text-center">
                        <div class="brand-name">@b.BrandName</div>
                        <span class="chip"><i class="fas fa-hashtag"></i>@b.BrandId.ToString().Substring(0, 6)</span>
                    </div>

                    <div class="actions">
                        <button class="btn-mini btn-edit"
                                data-bs-toggle="modal" data-bs-target="#updateBrandModal"
                                data-id="@b.BrandId" data-name="@b.BrandName" data-logo="@b.LogoUrl">
                            <i class="fas fa-pen"></i> Edit
                        </button>
                        <button class="btn-mini btn-del" onclick="askDelete('@b.BrandId','@b.BrandName')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty">
            <i class="fas fa-inbox fa-2x mb-2"></i>
            <div class="fw-bold">No brands yet</div>
            <div>Start by adding your first brand.</div>
        </div>
    }
</div>

<!-- Create Modal -->
<div class="modal fade" id="createBrandModal" tabindex="-1" aria-labelledby="createBrandLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createBrandLabel"><i class="fas fa-plus me-2 text-primary"></i>Create Brand</h5>
                <button class="btn btn-outline btn-sm" data-bs-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="createBrandForm">
                    <div class="mb-3">
                        <label class="form-label">Brand Name <span class="text-danger">*</span></label>
                        <input class="form-control" id="createBrandName" maxlength="80" required>
                    </div>
                    <div class="mb-1">
                        <label class="form-label">Logo URL</label>
                        <input class="form-control" id="createLogoUrl" placeholder="https://...">
                    </div>
                    <div class="form-text">Tip: Clean SVG/PNG logos look best.</div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-bs-dismiss="modal">Close</button>
                <button class="btn-primary-soft" id="saveCreateBtn"><i class="fas fa-check me-1"></i>Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Modal -->
<div class="modal fade" id="updateBrandModal" tabindex="-1" aria-labelledby="updateBrandLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateBrandLabel"><i class="fas fa-pen-to-square me-2 text-warning"></i>Update Brand</h5>
                <button class="btn btn-outline btn-sm" data-bs-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="updateBrandForm">
                    <input type="hidden" id="updateBrandId" />
                    <div class="mb-3">
                        <label class="form-label">Brand Name <span class="text-danger">*</span></label>
                        <input class="form-control" id="updateBrandName" maxlength="80" required>
                    </div>
                    <div>
                        <label class="form-label">Logo URL</label>
                        <input class="form-control" id="updateLogoUrl" placeholder="https://...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-bs-dismiss="modal">Close</button>
                <button class="btn-primary-soft" id="saveUpdateBtn"><i class="fas fa-floppy-disk me-1"></i>Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteBrandModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="mb-2"><i class="fas fa-triangle-exclamation text-danger"></i></div>
                <div class="fw-bold mb-2">Delete brand?</div>
                <div id="deleteBrandText" class="text-muted mb-3"></div>
                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger" id="confirmDeleteBtn"><i class="fas fa-trash me-1"></i>Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toastLite" class="toast-lite"></div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Tiny toast
        function toast(msg, ok=true){
          const el=document.getElementById('toastLite');
          el.className='toast-lite ' + (ok ? 'toast-ok' : 'toast-err');
          el.textContent=msg; el.style.display='block';
          setTimeout(()=>{el.style.display='none'}, 2200);
        }

        // Search filter
        $('#searchInput').on('input', function(){
          const q=$(this).val().toString().toLowerCase().trim();
          let shown=0;
          $('#brandGrid .card-brand').each(function(){
            const ok = !q || ($(this).data('name')||'').includes(q);
            $(this).toggle(ok); if(ok) shown++;
          });
        });

        // Fill UPDATE modal
        const updateModal=document.getElementById('updateBrandModal');
        updateModal?.addEventListener('show.bs.modal', function(ev){
          const btn=ev.relatedTarget;
          $('#updateBrandId').val(btn?.getAttribute('data-id')||'');
          $('#updateBrandName').val(btn?.getAttribute('data-name')||'');
          $('#updateLogoUrl').val(btn?.getAttribute('data-logo')||'');
        });

        // CREATE
        $('#saveCreateBtn').on('click', function(){
          const name=$('#createBrandName').val().trim();
          const logo=$('#createLogoUrl').val().trim();
          if(!name){ toast('Brand name is required', false); return; }

          $.ajax({
            url:'/Admin/AdminBrand/CreateBrand',
            type:'POST',
            contentType:'application/json',
            data: JSON.stringify({ BrandName:name, LogoUrl:logo }),
            success:function(){
              $('#createBrandModal').modal('hide');
              toast('Brand created');
              setTimeout(()=>location.reload(),900);
            },
            error:function(xhr){ toast((xhr.responseJSON?.message)||'Create failed', false); }
          });
        });

        // UPDATE
        $('#saveUpdateBtn').on('click', function(){
          const id=$('#updateBrandId').val();
          const name=$('#updateBrandName').val().trim();
          const logo=$('#updateLogoUrl').val().trim();
          if(!id || !name){ toast('BrandId & name required', false); return; }

          $.ajax({
            url:'/Admin/AdminBrand/UpdateBrand',
            type:'POST',
            contentType:'application/json',
            data: JSON.stringify({ BrandId:id, BrandName:name, LogoUrl:logo }),
            success:function(){
              $('#updateBrandModal').modal('hide');
              toast('Brand updated');
              setTimeout(()=>location.reload(),900);
            },
            error:function(xhr){ toast((xhr.responseJSON?.message)||'Update failed', false); }
          });
        });

        // DELETE
        let toDeleteId=null;
        window.askDelete=function(id, name){
          toDeleteId=id;
          document.getElementById('deleteBrandText').innerHTML=`<small>This action cannot be undone.</small><br><b>${name}</b> will be removed.`;
          new bootstrap.Modal(document.getElementById('deleteBrandModal')).show();
        };
        $('#confirmDeleteBtn').on('click', function(){
          if(!toDeleteId) return;
          $.ajax({
            url:'/Admin/AdminBrand/DeleteBrand/' + toDeleteId,
            type:'DELETE',
            success:function(){
              $('.modal').modal('hide');
              toast('Brand deleted');
              setTimeout(()=>location.reload(),900);
            },
            error:function(xhr){ toast((xhr.responseJSON?.message)||'Delete failed', false); }
          });
        });
    </script>
}
